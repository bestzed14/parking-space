<!doctype html>
<html lang="zh-Hant">
  <head>
    <meta charset="UTF-8" />
    <title>é™„è¿‘åœè»Šå ´ Leaflet åœ°åœ–</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <style>
      #map {
        height: 500px;
        width: 100%;
        margin-top: 1em;
      }
      .leaflet-popup-content {
        font-size: 14px;
      }
      .custom-img {
        max-width: 80%;
        margin: 0 auto;
        display: block;
      }
    </style>
  </head>
  <body>
    <div class="container my-5">
      <div class="row align-items-center">
        <div class="col-lg-6 col-md-6 col-12 mb-4 mb-md-0">
          <img
            src="/media/parking_images/search.jpg"
            alt="åœè»Šåœ–"
            class="img-fluid rounded shadow custom-img"
          />
        </div>

        <div class="col-lg-6 col-md-6 col-12">
          <h5 class="fw-bold">æœå°‹å¯ç”¨åœè»Šä½</h5>
          <p class="text-muted">
            <i class="bi bi-quote"></i>
            é€éæˆ‘å€‘çš„ç³»çµ±ï¼Œè¼•é¬†æœå°‹é™„è¿‘çš„å¯ç”¨åœè»Šä½ï¼Œæ‚¨åªéœ€è¼¸å…¥ç›®çš„åœ°ï¼Œç³»çµ±æœƒè‡ªå‹•ç‚ºæ‚¨æ‰¾åˆ°æœ€ä½³é¸æ“‡ã€‚
          </p>

          <form id="searchForm" class="mb-3">
            <input
              type="text"
              id="addressInput"
              placeholder="è«‹è¼¸å…¥åœ°å€"
              class="form-control mb-2"
            />
            <div class="form-check mb-3">
              <input
                type="checkbox"
                id="cheapestOnly"
                class="form-check-input"
              />
              <label class="form-check-label" for="cheapestOnly"
                >ä½åƒ¹å„ªå…ˆ</label
              >
            </div>
            <button type="submit" class="btn btn-dark w-100">ç«‹å³æœå°‹</button>
          </form>
          <button onclick="getLocation()" class="btn btn-outline-primary mb-2">ğŸ§­ ä¸€éµæœå°‹</button>
          <p id="result"></p>
        </div>
      </div>
    </div>

    <div id="map" style="height: 500px; width: 100%; margin-top: 1em"></div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
      //Taipei Taoyuan Taichung Tainan Kaohsiung Keelung ChanghuaCounty YunlinCounty
      // PingtungCounty YilanCounty HualienCounty KinmenCounty
      const redIcon = new L.Icon({
        iconUrl:
          "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
        iconRetinaUrl:
          "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png",
        shadowUrl:
          "https://unpkg.com/leaflet@1.9.4/dist/images/marker-shadow.png",
        iconSize: [25, 41],
        iconAnchor: [12, 41],
        popupAnchor: [1, -34],
        shadowSize: [41, 41],
      });

      let map = L.map("map").setView([25.033, 121.5654], 13); // å°åŒ—å¸‚é è¨­ä¸­å¿ƒ

      L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
        maxZoom: 18,
        attribution: "Â© OpenStreetMap",
      }).addTo(map);

      let markers = [];

      // è¡¨å–®é€å‡ºè™•ç†
      document
        .getElementById("searchForm")
        .addEventListener("submit", async function (e) {
          e.preventDefault(); // é˜»æ­¢åŸæœ¬æäº¤

          const address = document.getElementById("addressInput").value.trim();
          if (!address) return alert("è«‹è¼¸å…¥åœ°å€");

          try {
            // ç¬¬ä¸€æ­¥ï¼šç”¨åœ°å€æ›ç¶“ç·¯åº¦
            const geoRes = await fetch(
              `/myapp/geocode_address?address=${encodeURIComponent(address)}`
            );
            const geoData = await geoRes.json();
            if (!geoRes.ok) throw new Error(geoData.error || "æ‰¾ä¸åˆ°ä½ç½®");

            const { lat, lon, city } = geoData;
            console.log(geoData);

            // ç§»å‹•åœ°åœ–
            map.setView([lat, lon], 13);

            // æ¸…é™¤èˆŠçš„ marker
            markers.forEach((m) => map.removeLayer(m));
            markers = [];

            // æ¨™è¨˜æœå°‹ä¸­å¿ƒé»
            const centerMarker = L.marker([lat, lon], { icon: redIcon })
              .addTo(map)
              .bindPopup(`æŸ¥è©¢ä½ç½®: ${lat}, ${lon}`)
              .openPopup();
            markers.push(centerMarker);

            // ç¬¬äºŒæ­¥: æ›´æ–°åœè»Šè³‡è¨Šè‡³DB
            console.log("UpdataDB-city:" + city);
            const upDBRes = await fetch(
              `/myapp/update_PSA_CP/?city=${city}`
            ).catch((error) => {
              console.error("âŒ éŒ¯èª¤:", error);
            });

            //// ç¬¬ä¸‰æ­¥ï¼šç”¨ç¶“ç·¯åº¦æŸ¥è©¢é™„è¿‘åœè»Šå ´
            console.log("Search-point-city:" + city);
            //const city = 'Taipei'; // ä½ å¯ä¾å¯¦éš›é‚è¼¯è‡ªå‹•åˆ¤æ–·åŸå¸‚
            const cheapestOnly =
              document.getElementById("cheapestOnly").checked;
            let url;
            if (cheapestOnly) {
              url = `/myapp/cheapest_nearby_parking?lat=${lat}&lon=${lon}&city=${encodeURIComponent(city)}`;
            } else {
              url = `/myapp/nearby_parking?lat=${lat}&lon=${lon}&city=${encodeURIComponent(city)}`;
            }
            fetch(url)
              .then((res) => res.json())
              .then((data) => {
                // åŠ å…¥åœè»Šå ´æ¨™è¨˜
                for (const p of data.data) {
                  console.log(p);
                  const marker = L.marker([p.lat, p.lon]).addTo(map).bindPopup(`
              <b>${p.name}</b><br/>
              å¯ç”¨ï¼š${p.available_spaces} / ${p.total_spaces}<br/>
              è·é›¢ï¼š${p.distance_km} å…¬é‡Œ<br/>
              åƒ¹æ ¼:${p.hourly_fee}å…ƒ<br/>
              <a href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}" target="_blank">â¤ å°èˆª</a>
            `);
                  markers.push(marker);
                }
              });
          } catch (err) {
            alert(err.message);
          }
        });
    </script>
    
    <script>
    async function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                async function(position) {
                    const lat = position.coords.latitude;
                    const lon = position.coords.longitude;

                    try {
                        // ç¬¬ä¸€æ­¥ï¼šé€éç¶“ç·¯åº¦æŸ¥è©¢åŸå¸‚è‹±æ–‡
                        const res = await fetch(`/get_location_info/?lat=${lat}&lon=${lon}`);
                        const data = await res.json();

                        if (data.city) {
                            const city = data.city;
                            document.getElementById("result").innerText =
                                `ä½ çš„ä½ç½®ï¼š(${lat}, ${lon})ï¼ŒåŸå¸‚ï¼š${city}`;

                            console.log("ä½ç½®è³‡è¨Šï¼š", data);

                            // ç§»å‹•åœ°åœ–
                            map.setView([lat, lon], 13);

                            // æ¸…é™¤èˆŠçš„ marker
                            markers.forEach((m) => map.removeLayer(m));
                            markers = [];

                            // æ¨™è¨˜æœå°‹ä¸­å¿ƒé»
                            const centerMarker = L.marker([lat, lon], { icon: redIcon })
                                .addTo(map)
                                .bindPopup(`æŸ¥è©¢ä½ç½®: ${lat}, ${lon}`)
                                .openPopup();
                            markers.push(centerMarker);

                            // ç¬¬äºŒæ­¥ï¼šæ›´æ–°åœè»Šè³‡è¨Šåˆ°è³‡æ–™åº«
                            console.log("æ›´æ–° DB - city: " + city);
                            await fetch(`/myapp/update_PSA_CP/?city=${city}`);

                            // ç¬¬ä¸‰æ­¥ï¼šæŸ¥è©¢é™„è¿‘åœè»Šå ´ï¼ˆæœ€ä¾¿å®œ or å…¨éƒ¨ï¼‰
                            const cheapestOnly = document.getElementById("cheapestOnly").checked;
                            let url = cheapestOnly
                                ? `/myapp/cheapest_nearby_parking?lat=${lat}&lon=${lon}&city=${encodeURIComponent(city)}`
                                : `/myapp/nearby_parking?lat=${lat}&lon=${lon}&city=${encodeURIComponent(city)}`;

                            const nearbyRes = await fetch(url);
                            const nearbyData = await nearbyRes.json();

                            for (const p of nearbyData.data) {
                                console.log(p);
                                const marker = L.marker([p.lat, p.lon]).addTo(map).bindPopup(`
                                    <b>${p.name}</b><br/>
                                    å¯ç”¨ï¼š${p.available_spaces} / ${p.total_spaces}<br/>
                                    è·é›¢ï¼š${p.distance_km} å…¬é‡Œ<br/>
                                    åƒ¹æ ¼:${p.hourly_fee}å…ƒ<br/>
                                    <a href="https://www.google.com/maps/dir/?api=1&destination=${p.lat},${p.lon}" target="_blank">â¤ å°èˆª</a>
                                `);
                                markers.push(marker);
                            }

                        } else {
                            document.getElementById("result").innerText = "æ‰¾ä¸åˆ°åŸå¸‚è³‡è¨Š";
                        }

                    } catch (err) {
                        console.error(err);
                        alert("ç™¼ç”ŸéŒ¯èª¤ï¼š" + err.message);
                    }
                },
                function(error) {
                    document.getElementById("result").innerText = "ç„¡æ³•å®šä½ï¼š" + error.message;
                }
            );
        } else {
            document.getElementById("result").innerText = "ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½";
        }
    }
</script>

  </body>
</html>
